# https://circleci.com/docs/configuration#machine
machine:
  php:
    # https://circleci.com/docs/environment#php
    version: 5.5.11
  environment:
    # DB config. Using default CircleCI's database.
    PANTHEON_BRANCH: ci$CIRCLE_BUILD_NUM
    PANTHEON_SITE: migrate-pantheon-d8
    PANTHEON_D7_SITE: migrate-pantheon-d7
    PANTHEON_D7_BRANCH: dev
    BEHAT_PARAMS: '{"extensions" : {"Behat\\MinkExtension" : {"base_url" : "http://$PANTHEON_BRANCH-$PANTHEON_SITE.pantheonsite.io"} }}'

dependencies:
  cache_directories:
    - ~/.composer/cache
  post:
    - composer global require pantheon-systems/terminus
    - mkdir -p ~/terminus/plugins
    - git clone https://github.com/greg-1-anderson/terminus-secrets-plugin  ~/terminus/plugins/terminus-secrets-plugin
    - terminus auth login --machine-token=$TerminusToken
test:
  pre:

    # Make a new multidev env from a vanilla D8 site.
    - cd ~/migrate_pantheon/tests/circle && ./create-fresh-d8-site

    # Set up the D8 site with contrib migrate contrib modules and enable
    # those modules on Panetheon.
    - cd ~/migrate_pantheon/tests/circle && ./setup-d8-site

    # Configure the migration, creating exportable, re-runnable configuration.
    - cd ~/migrate_pantheon/tests/circle && ./setup-migration-config

    # Run the actual migration on Pantheon.
    - cd ~/migrate_pantheon/tests/circle && ./run-migration-on-pantheon

  override:
    # Check that a node actually migrated.
    - cd ~/migrate_pantheon/tests/circle && ./verify-migration-succeeded
